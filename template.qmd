---
title: "Enhanced Medical Device Report"
subtitle: "A Comprehensive Template with Advanced Quarto Features"
author: "Your Name"
date: today
lof: true  # List of Figures
lot: true  # List of Tables
toc: true  # Table of Contents
version: 1.0
format:
  medstata-typst: default
  # html: default
  # docx: default
keep-typ: false
execute: 
  echo: false
  warning: false
  eval: true
  fig-width: 7
  fig-height: 5
  freeze: auto
---

```{r echo=FALSE, message=FALSE}
library(ggplot2)
library(tidyverse)
library(knitr)

# Wilson 95% CI helper function for proportions
prop_ci <- function(x, n, conf = 0.95) {
  if (!requireNamespace("binom", quietly = TRUE)) {
    warning("binom package not installed, using prop.test fallback")
    pt <- prop.test(x, n, conf.level = conf, correct = FALSE)
    return(c(lower = pt$conf.int[1], upper = pt$conf.int[2]))
  } else {
    ci <- binom::binom.confint(x, n, methods = "wilson")
    return(c(lower = ci$lower, upper = ci$upper))
  }
}

# Custom ggplot2 theme matching base R aesthetics
theme_baseR <- function(base_size = 12) {
  theme_classic(base_size = base_size) %+replace%
    theme(
      panel.grid = element_blank(),
      panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
      axis.line = element_blank(),
      axis.ticks = element_line(color = "black"),
      plot.title = element_text(
        hjust = 0.5,
        face = "bold",
        margin = margin(b = 20, t = 10)
      ),
      plot.margin = unit(c(1.5, 1.5, 1, 1.5), "lines"),
      plot.title.position = "plot"
    )
}

theme_set(theme_baseR())
```

# Executive Summary

## Overview

This template demonstrates advanced Quarto features for creating professional medical device reports. It combines the best practices from both reference documents, incorporating:

- **Cross-referencing** for figures and tables
- **Callout blocks** for key findings
- **Panel tabsets** for organized content
- **Inline R calculations** for dynamic reporting
- **Typst integration** for advanced formatting
- **Custom visualizations** with both ggplot2 and base R

::: {.callout-important}
## Key Template Features
This template includes code chunks for data generation, analysis, and visualization that can be adapted to your specific medical device data. All examples use synthetic data for demonstration purposes.
:::

# Introduction

{{< lipsum 3 >}}

## Background

This section demonstrates how to structure your introduction with clear objectives and context.

## Study Design Overview

```{r}
# Example: Generate synthetic study data
set.seed(123)
n_patients <- 250

study_data <- tibble(
  patient_id = 1:n_patients,
  age = sample(18:85, n_patients, replace = TRUE),
  gender = sample(c("Male", "Female", "Other"), n_patients, replace = TRUE, 
                  prob = c(0.48, 0.51, 0.01)),
  treatment_group = sample(c("Device A", "Device B", "Control"), n_patients, 
                           replace = TRUE),
  outcome_score = rnorm(n_patients, mean = 75, sd = 15),
  satisfaction = sample(1:5, n_patients, replace = TRUE, 
                       prob = c(0.05, 0.10, 0.15, 0.40, 0.30)),
  adverse_event = sample(c("Yes", "No"), n_patients, replace = TRUE, 
                        prob = c(0.08, 0.92))
)
```

## Methodology

**Study Population:** N = `r nrow(study_data)` participants  
**Duration:** 12 months  
**Primary Endpoint:** Treatment outcome score  
**Secondary Endpoints:** Patient satisfaction and safety

# Results

## Demographics and Baseline Characteristics

```{r}
#| label: tbl-demographics
#| tbl-cap: "Baseline characteristics by treatment group"

demo_summary <- study_data %>%
  group_by(treatment_group) %>%
  summarize(
    N = n(),
    `Mean Age (SD)` = sprintf("%.1f (%.1f)", mean(age), sd(age)),
    `Female (%)` = sprintf("%.1f%%", mean(gender == "Female") * 100),
    `Baseline Score (SD)` = sprintf("%.1f (%.1f)", 
                                     mean(outcome_score), sd(outcome_score))
  )

kable(demo_summary)
```

As shown in @tbl-demographics, baseline characteristics were well-balanced across treatment groups.

## Primary Outcome Analysis

```{r}
#| label: fig-outcomes
#| fig-cap: "Distribution of outcome scores by treatment group"
#| fig-width: 8
#| fig-height: 5

ggplot(study_data, aes(x = treatment_group, y = outcome_score, fill = treatment_group)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.3) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Treatment Outcomes by Study Group",
    x = "Treatment Group",
    y = "Outcome Score",
    fill = "Treatment"
  ) +
  theme(legend.position = "none")
```

The primary analysis (@fig-outcomes) demonstrates the distribution of outcome scores across treatment groups.
Also we can try to link to quarto website [here](https://quarto.org).

## Statistical Analysis with Confidence Intervals

```{r}
#| label: tbl-outcomes-ci
#| tbl-cap: "Primary outcome results with 95% confidence intervals"

outcome_analysis <- study_data %>%
  group_by(treatment_group) %>%
  summarize(
    N = n(),
    Mean = mean(outcome_score),
    SD = sd(outcome_score),
    SE = SD / sqrt(N),
    CI_lower = Mean - 1.96 * SE,
    CI_upper = Mean + 1.96 * SE
  ) %>%
  mutate(
    `Mean (95% CI)` = sprintf("%.1f (%.1f – %.1f)", Mean, CI_lower, CI_upper)
  ) %>%
  select(treatment_group, N, `Mean (95% CI)`)

kable(outcome_analysis, col.names = c("Treatment Group", "N", "Mean (95% CI)"))
```

## Patient Satisfaction Analysis

### Overall Satisfaction Distribution

```{r}
#| label: fig-satisfaction
#| fig-cap: "Patient satisfaction ratings across all groups"
#| fig-width: 8
#| fig-height: 6

satisfaction_data <- study_data %>%
  mutate(
    satisfaction_label = factor(satisfaction,
      levels = 1:5,
      labels = c("Very Dissatisfied", "Dissatisfied", "Neutral", 
                 "Satisfied", "Very Satisfied")
    )
  )

ggplot(satisfaction_data, aes(x = treatment_group, fill = satisfaction_label)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "RdYlGn", direction = 1) +
  labs(
    title = "Patient Satisfaction Distribution",
    x = "Treatment Group",
    y = "Percentage of Patients",
    fill = "Satisfaction Level"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Satisfaction by Demographics

::: {.panel-tabset}

### By Age Group

```{r}
#| fig-cap: "Satisfaction scores by age group"
#| fig-width: 7
#| fig-height: 4

study_data %>%
  mutate(age_group = cut(age, breaks = c(0, 40, 60, 100), 
                         labels = c("18-40", "41-60", "60+"))) %>%
  group_by(age_group) %>%
  summarize(mean_satisfaction = mean(satisfaction)) %>%
  ggplot(aes(x = age_group, y = mean_satisfaction)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(
    title = "Mean Satisfaction by Age Group",
    x = "Age Group",
    y = "Mean Satisfaction Score (1-5)"
  ) +
  ylim(0, 5)
```

### By Gender

```{r}
#| fig-cap: "Satisfaction scores by gender"
#| fig-width: 7
#| fig-height: 4

study_data %>%
  filter(gender %in% c("Male", "Female")) %>%
  group_by(gender) %>%
  summarize(mean_satisfaction = mean(satisfaction)) %>%
  ggplot(aes(x = gender, y = mean_satisfaction)) +
  geom_bar(stat = "identity", fill = "coral") +
  labs(
    title = "Mean Satisfaction by Gender",
    x = "Gender",
    y = "Mean Satisfaction Score (1-5)"
  ) +
  ylim(0, 5)
```

### By Treatment

```{r}
#| fig-cap: "Satisfaction scores by treatment group"
#| fig-width: 7
#| fig-height: 4

study_data %>%
  group_by(treatment_group) %>%
  summarize(mean_satisfaction = mean(satisfaction)) %>%
  ggplot(aes(x = reorder(treatment_group, mean_satisfaction), 
             y = mean_satisfaction)) +
  geom_bar(stat = "identity", fill = "forestgreen") +
  coord_flip() +
  labs(
    title = "Mean Satisfaction by Treatment Group",
    x = "Treatment Group",
    y = "Mean Satisfaction Score (1-5)"
  ) +
  ylim(0, 5)
```

:::

## Safety Analysis

```{r}
#| label: tbl-safety
#| tbl-cap: "Adverse event rates by treatment group with Wilson 95% CI"

safety_summary <- study_data %>%
  group_by(treatment_group) %>%
  summarize(
    N = n(),
    Events = sum(adverse_event == "Yes")
  ) %>%
  rowwise() %>%
  mutate(
    Proportion = Events / N,
    ci = list(prop_ci(Events, N)),
    CI_lower = ci[["lower"]] * 100,
    CI_upper = ci[["upper"]] * 100,
    `Rate (%)` = sprintf("%.1f%%", Proportion * 100),
    `95% CI` = sprintf("%.1f%% – %.1f%%", CI_lower, CI_upper)
  ) %>%
  select(treatment_group, N, Events, `Rate (%)`, `95% CI`)

kable(safety_summary, col.names = c("Treatment Group", "N", "Events", 
                                    "Rate (%)", "95% CI"))
```

::: {.callout-note}
## Safety Profile
All adverse event rates were within expected ranges for this device class. No serious adverse events were reported.
:::

## Comparison with Base R Visualization

While ggplot2 provides elegant visualizations, base R can be useful for certain applications:

```{r}
#| label: fig-base-r
#| fig-cap: "Treatment outcomes - Base R visualization"
#| fig-width: 7
#| fig-height: 5

# Create boxplot using base R
boxplot(outcome_score ~ treatment_group, 
        data = study_data,
        col = c("lightblue", "lightgreen", "lightcoral"),
        main = "Treatment Outcomes by Study Group (Base R)",
        xlab = "Treatment Group",
        ylab = "Outcome Score",
        las = 1)

# Add sample size labels
group_counts <- table(study_data$treatment_group)
axis(1, at = 1:3, labels = paste0("n=", group_counts), line = 1, tick = FALSE)
```

# Advanced Typst Features

## Custom Styled Callout Boxes

```{=typst}
#let highlight(content) = {
  box(
    fill: blue.lighten(90%),
    inset: (x: 10pt, y: 8pt),
    outset: (y: 5pt),
    radius: 4pt,
    content
  )
}

#highlight[
  *Key Finding:* The treatment demonstrated statistically significant improvement 
  in outcome scores compared to control (p < 0.001). Effect size was clinically 
  meaningful (Cohen's d = 0.8).
]
```

## Two-Column Layout

```{=typst}
#grid(
  columns: (1fr, 1fr),
  gutter: 1.5em,
  [
    #set par(leading: 0.65em)
    *Clinical Significance*
    
    The observed improvements in patient outcomes represent clinically meaningful 
    changes. Effect sizes exceeded minimal clinically important difference (MCID) 
    thresholds established in prior literature.
  ],
  [
    #set par(leading: 0.65em)
    *Safety Considerations*
    
    The safety profile was favorable with adverse event rates comparable to 
    standard of care. No device-related serious adverse events were reported 
    during the study period.
  ]
)
```

## Custom Tables

```{=typst}
#table(
  columns: (auto, auto, auto),
  inset: 10pt,
  align: horizon,
  stroke: 0.7pt,
  [*Endpoint*], [*Result*], [*Interpretation*],
  [Primary Efficacy], [✓ Met], [Statistically significant],
  [Primary Safety], [✓ Met], [Within acceptable limits],
  [Patient Satisfaction], [✓ Met], [High approval ratings],
  [Cost Effectiveness], [✓ Met], [Favorable economic profile]
)
```

# Cross-References and Citations

You can reference any figure or table using the `@` syntax:

- See @fig-outcomes for primary outcome results
- Demographics are presented in @tbl-demographics
- Safety data is summarized in @tbl-safety
- Base R comparison shown in @fig-base-r

# Discussion

## Key Findings Summary

::: {.callout-tip}
## Clinical Implications

The findings from this study support the following clinical recommendations:

1. The device demonstrates significant efficacy improvements
2. Safety profile is favorable and comparable to standard of care
3. High patient satisfaction suggests good acceptability
4. Economic analysis supports cost-effectiveness
:::

## Limitations

::: {.callout-warning}
## Study Limitations

- Single-center study limiting generalizability
- Relatively short follow-up period
- Selection bias inherent to observational design
- Missing data for some secondary endpoints
:::

## Comparison with Literature

This section would compare your findings with published literature.

# Conclusions

## Summary Statement

This study provides evidence for the safety and efficacy of the medical device under investigation.

## Recommendations

```{=typst}
#let action(title, timing, description) = {
  block(
    fill: blue.lighten(95%),
    inset: (x: 10pt, y: 8pt),
    radius: 4pt,
    width: 100%,
    [
      #text(weight: "bold")[#title] #h(1fr) #text(style: "italic")[#timing]
      
      #description
    ]
  )
}

#action(
  "Expanded Clinical Trial",
  "Q1 2026",
  [Conduct multi-center randomized controlled trial to confirm findings in broader 
   population and establish long-term safety profile.]
)

#v(8pt)

#action(
  "Real-World Evidence Study",
  "Q2 2026",
  [Implement post-market surveillance program to collect real-world effectiveness 
   and safety data from routine clinical practice.]
)

#v(8pt)

#action(
  "Health Economics Analysis",
  "Q3 2026",
  [Perform comprehensive cost-effectiveness analysis comparing device to current 
   standard of care across multiple healthcare systems.]
)
```

```{=typst}
#pagebreak()
```

# Administrative Information

## Document History

```{=typst}
#table(
  columns: (auto, auto, auto, 1fr),
  inset: 10pt,
  align: horizon,
  stroke: 0.7pt,

  [*Version*], [*Date*], [*Author*], [*Description*],

  [0.1], [01 Jan 2025], [Author Name], [Initial draft],
  [0.2], [15 Jan 2025], [Author Name], [Incorporated reviewer comments],
  [1.0], [12 Oct 2025], [Author Name], [Final version for submission]
)
```

## Approval Signatures

```{=typst}
#table(
  columns: (auto, auto, 1fr, 1fr),
  inset: 10pt,
  align: horizon,
  stroke: 0.7pt,

  [*Role*], [*Name*], [*Signature*], [*Date*],

  [Principal Investigator], [Dr. Jane Smith], [], [],
  [Statistician], [Dr. John Doe], [], [],
  [Quality Assurance], [Ms. Sarah Johnson], [], [],
  [Regulatory Affairs], [Mr. Michael Brown], [], []
)
```

# References {.unnumbered}

::: {#refs}
:::

```{=typst}
#pagebreak()
```

# Appendices {.unnumbered}

## Appendix A: Additional Tables {.unnumbered}

```{r}
#| label: tbl-detailed-demographics
#| tbl-cap: "Detailed demographic breakdown"

detailed_demo <- study_data %>%
  summarize(
    `Mean Age (years)` = mean(age),
    `SD Age` = sd(age),
    `Min Age` = min(age),
    `Max Age` = max(age),
    `Female %` = mean(gender == "Female") * 100,
    `Male %` = mean(gender == "Male") * 100
  )

kable(detailed_demo, digits = 1)
```

## Appendix B: Statistical Methods {.unnumbered}

### Analysis Populations {.unnumbered}

- **Full Analysis Set (FAS):** All enrolled patients (N=`r nrow(study_data)`)
- **Per-Protocol Set (PPS):** Patients completing study per protocol
- **Safety Population:** All patients receiving at least one treatment

### Statistical Tests {.unnumbered}

- Primary outcome: ANOVA with post-hoc Tukey HSD
- Proportions: Wilson score confidence intervals
- Significance level: α = 0.05 (two-sided)

## Appendix C: Protocol Synopsis {.unnumbered}

This section would include key elements of your study protocol.

# Reproducibility Information {.unnumbered}

## Session Information {.unnumbered}

```{r}
sessionInfo()
```

## Complete Analysis Code {.unnumbered}

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```